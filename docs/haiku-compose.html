<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>俳句を詠む - 吟行</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- OGP Meta Tags -->
    <meta property="og:site_name" content="吟行">
    <meta property="og:title" content="吟行 - 俳句鑑賞＆記録アプリ">
    <meta property="og:description" content="俳句・短歌の名句ゆかりの地を巡り、その場で詠まれた作品を鑑賞できるアプリ">
    <meta property="og:image" content="https://psmuler.github.io/gingko/ogp.png">
    <meta property="og:image:width" content="2400">
    <meta property="og:image:height" content="1260">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://psmuler.github.io/gingko/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://psmuler.github.io/gingko/ogp.png">

    <link rel="stylesheet" href="css/styles.css">

    <!-- Supabase JavaScript SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1>俳句を詠む</h1>
                <p id="header-subtitle">選んだ季語: <span id="selected-kigo-display"></span></p>
            </div>
            <button class="menu-toggle" onclick="goBack()" style="width: 40px; height: 40px; background: transparent; border: none; color: white; font-size: 2rem; cursor: pointer; border-radius: 50%; transition: background 0.2s;">
                ×
            </button>
        </header>

        <!-- Main Content -->
        <main style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; background: var(--secondary-color);">
            <div class="modal-content" style="max-width: 600px; width: 100%; padding: 30px;" id="form-container">
                <!-- Form will be dynamically generated by haiku-form-component.js -->
            </div>
        </main>
    </div>

    <!-- ES Module Scripts -->
    <script type="module">
        import './js/utils.js';
        import { initializeKigoSuggestions, getCurrentKigoSelection } from './js/kigo-suggestions.js';
        import { getSupabaseClient } from './js/supabase-client.js';
        import { apiAdapter } from './js/api-adapter.js';
        import { createHaikuForm, initializeKigoSuggestion } from './js/haiku-form-component.js';

        let selectedKigoFromGatcha = null;
        let editMode = false;
        let editingHaikuId = null;

        const utils = window.utils || {};
        const debounceFn = typeof utils.debounce === 'function' ? utils.debounce : (fn) => fn;
        const saveDraftToLocal = typeof utils.saveDraftToLocal === 'function' ? utils.saveDraftToLocal : null;
        const loadDraftFromLocal = typeof utils.loadDraftFromLocal === 'function' ? utils.loadDraftFromLocal : null;
        const clearDraftFromLocal = typeof utils.clearDraftFromLocal === 'function' ? utils.clearDraftFromLocal : null;
        const hasLocalStorageSupport = typeof utils.hasLocalStorageSupport === 'function'
            ? utils.hasLocalStorageSupport
            : () => false;
        const DRAFT_STORAGE_KEY = utils.DEFAULT_DRAFT_STORAGE_KEY || 'gingko_current_draft';
        const canUseDraftStorage = hasLocalStorageSupport();
        const draftStorageOptions = { key: DRAFT_STORAGE_KEY };

        let currentDraftLocation = null;
        let pendingLocationPromise = null;
        let draftRestored = false;

        // Initialize
        async function init() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const kigoParam = urlParams.get('kigo');
            const experiencedParam = urlParams.get('experienced');
            const editParam = urlParams.get('edit');

            // Update header subtitle based on source
            const headerSubtitle = document.getElementById('header-subtitle');

            // 編集モードの判定
            if (editParam) {
                editMode = true;
                editingHaikuId = parseInt(editParam);

                // ヘッダー変更
                const headerTitle = document.querySelector('header h1');
                if (headerTitle) {
                    headerTitle.textContent = '俳句を編集';
                }
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            } else if (experiencedParam === 'true') {
                // Experienced user - hide kigo display
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            } else if (kigoParam) {
                selectedKigoFromGatcha = {
                    kigo: decodeURIComponent(kigoParam),
                    season: urlParams.get('season') || null,
                    seasonJa: urlParams.get('seasonJa') || null
                };

                // Display selected kigo
                const displayElement = document.getElementById('selected-kigo-display');
                if (displayElement) {
                    displayElement.textContent = `${selectedKigoFromGatcha.kigo}（${selectedKigoFromGatcha.seasonJa || ''}）`;
                }
            } else {
                // No kigo parameter - hide subtitle
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            }

            // Generate form using component
            const formContainer = document.getElementById('form-container');
            if (formContainer) {
                // Determine placeholder based on source
                let placeholder;
                if (editMode) {
                    placeholder = '読み込み中...';
                } else if (experiencedParam === 'true') {
                    placeholder = '一番最近詠んだ句は';
                } else if (selectedKigoFromGatcha) {
                    placeholder = selectedKigoFromGatcha.kigo;
                } else {
                    placeholder = '斧入れて香に驚くや冬木立';
                }

                const formHTML = createHaikuForm({
                    formId: 'haiku-compose-form',
                    textAreaId: 'haiku-text',
                    suggestionsId: 'kigo-suggestions',
                    showPoetField: true,
                    showHeader: false,
                    showSwipeIndicator: false,
                    submitButtonText: editMode ? '更新する' : '詠んだ！',
                    placeholder: placeholder
                });
                formContainer.innerHTML = formHTML;

                // Setup form submit handler
                const form = document.getElementById('haiku-compose-form');
                if (form) {
                    form.addEventListener('submit', submitHaiku);
                }

                console.log('✅ フォーム生成完了 (component化)');
            }

            // 編集モードの場合、既存データを読み込む
            if (editMode && editingHaikuId) {
                await loadHaikuForEdit(editingHaikuId);
            }

            await maybeRestoreDraft();

            setupDraftAutoSave();

            // Initialize kigo suggestion feature
            try {
                await initializeKigoSuggestions();
                await initializeKigoSuggestion('haiku-text', 'kigo-suggestions');
                console.log('✅ 季語サジェスト機能初期化完了');
            } catch (error) {
                console.error('❌ 季語サジェスト機能初期化エラー:', error);
            }
        }

        function setupDraftAutoSave() {
            if (!canUseDraftStorage || !saveDraftToLocal || !loadDraftFromLocal || !clearDraftFromLocal) {
                return;
            }

            const textArea = document.getElementById('haiku-text');
            const poetInput = document.getElementById('poet-name');

            if (!textArea) {
                console.warn('⚠️ Draft auto-save unavailable: textarea not found');
                return;
            }

            const debouncedSave = debounceFn(async () => {
                const textValue = textArea.value;
                const trimmedText = textValue.trim();

                if (!trimmedText) {
                    clearDraftFromLocal && clearDraftFromLocal(draftStorageOptions);
                    return;
                }

                const location = await ensureDraftLocation();

                const draftContext = editMode ? 'compose-edit' : 'compose';

                saveDraftToLocal({
                    text: trimmedText,
                    rawText: textValue,
                    poetName: poetInput ? poetInput.value.trim() : '',
                    location,
                    mode: editMode ? 'edit' : 'create',
                    haikuId: editMode ? editingHaikuId : null,
                    context: draftContext
                }, draftStorageOptions);
            }, 300);

            textArea.addEventListener('input', debouncedSave);
            if (poetInput) {
                poetInput.addEventListener('input', debouncedSave);
            }

            if (draftRestored) {
                debouncedSave();
            }
        }

        async function ensureDraftLocation() {
            if (currentDraftLocation) {
                return currentDraftLocation;
            }

            if (pendingLocationPromise) {
                return pendingLocationPromise;
            }

            pendingLocationPromise = getCurrentLocationOrDefault()
                .then((location) => {
                    currentDraftLocation = location;
                    return location;
                })
                .catch((error) => {
                    console.warn('⚠️ Failed to obtain location for draft storage:', error);
                    return null;
                })
                .finally(() => {
                    pendingLocationPromise = null;
                });

            return pendingLocationPromise;
        }

        async function maybeRestoreDraft() {
            if (!canUseDraftStorage || !loadDraftFromLocal) {
                return;
            }

            const storedDraft = loadDraftFromLocal(draftStorageOptions);
            if (!storedDraft || !storedDraft.text) {
                return;
            }

            const expectedContext = editMode ? 'compose-edit' : 'compose';

            if (storedDraft.context && storedDraft.context !== expectedContext) {
                return;
            }

            if (editMode) {
                if (storedDraft.mode !== 'edit' || storedDraft.haikuId !== editingHaikuId) {
                    return;
                }
            } else if (storedDraft.mode === 'edit') {
                return;
            }

            const shouldRestore = confirm('前回の入力を復元しますか？');
            if (!shouldRestore) {
                clearDraftFromLocal && clearDraftFromLocal(draftStorageOptions);
                return;
            }

            const textArea = document.getElementById('haiku-text');
            const poetInput = document.getElementById('poet-name');

            if (textArea) {
                textArea.value = storedDraft.rawText || storedDraft.text || '';
            }

            if (poetInput && storedDraft.poetName) {
                poetInput.value = storedDraft.poetName;
            }

            if (storedDraft.location) {
                currentDraftLocation = storedDraft.location;
            }

            draftRestored = true;
        }

        // Load haiku data for editing
        async function loadHaikuForEdit(haikuId) {
            try {
                console.log(`📖 俳句データ読み込み中: ID=${haikuId}`);
                const haiku = await apiAdapter.getHaiku(haikuId);

                if (!haiku) {
                    throw new Error('俳句が見つかりませんでした');
                }

                // フォームにデータを設定
                const haikuTextArea = document.getElementById('haiku-text');
                const poetNameInput = document.getElementById('poet-name');

                if (haikuTextArea) {
                    haikuTextArea.value = haiku.haiku_text || '';
                }

                if (poetNameInput) {
                    poetNameInput.value = haiku.poet_name || '';
                }

                console.log('✅ 俳句データ読み込み完了:', haiku);
            } catch (error) {
                console.error('❌ 俳句データ読み込みエラー:', error);
                alert('俳句データの読み込みに失敗しました');
                window.location.href = 'home.html';
            }
        }

        // Submit haiku
        window.submitHaiku = async function (event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-haiku-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = editMode ? '更新中...' : '投稿中...';

            try {
                // Get form data
                const haikuText = document.getElementById('haiku-text').value;
                const poetName = document.getElementById('poet-name').value;

                // Get kigo selection
                const kigoSelection = getCurrentKigoSelection();

                // Get or create poet_id
                let poetId = null;

                if (poetName && poetName !== '詠み人知らず') {
                    const existingPoets = await apiAdapter.searchPoets(poetName);
                    if (existingPoets && existingPoets.length > 0) {
                        poetId = existingPoets[0].id;
                    }
                }

                // Prepare haiku data
                const haikuData = {
                    haiku_text: haikuText,
                    poet_id: poetId,
                    season: kigoSelection.season || null,
                    seasonal_term: kigoSelection.selectedKigo?.display_name || null
                };

                // 編集モードの場合は位置情報を含めない（既存のまま）
                if (!editMode) {
                    // Get current location or use default
                    const location = await getCurrentLocationOrDefault();
                    haikuData.latitude = location.latitude;
                    haikuData.longitude = location.longitude;
                    haikuData.location_name = location.name;
                    haikuData.location_type = 'ゆかりの地';
                }

                console.log(`📤 ${editMode ? '更新' : '投稿'}データ:`, haikuData);

                // Submit or update using API adapter
                let result;
                if (editMode) {
                    result = await apiAdapter.updateHaiku(editingHaikuId, haikuData);
                } else {
                    result = await apiAdapter.createHaiku(haikuData);
                }

                if (!result.success) {
                    throw new Error(`${editMode ? '更新' : '投稿'}に失敗しました`);
                }

                console.log(`✅ ${editMode ? '更新' : '投稿'}成功:`, result);
                if (clearDraftFromLocal) {
                    clearDraftFromLocal(draftStorageOptions);
                }

                alert(`俳句を${editMode ? '更新' : '投稿'}しました！`);

                // Redirect to home
                window.location.href = 'home.html';

            } catch (error) {
                console.error(`❌ ${editMode ? '更新' : '投稿'}エラー:`, error);
                alert(`${editMode ? '更新' : '投稿'}に失敗しました。もう一度お試しください。`);
                submitBtn.disabled = false;
                submitBtn.textContent = editMode ? '更新する' : '詠んだ！';
            }
        };

        // Get current location or use default (Tokyo)
        async function getCurrentLocationOrDefault() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn('⚠️ 位置情報がサポートされていません。デフォルト位置を使用します。');
                    resolve({
                        latitude: 35.6809591,
                        longitude: 139.7673068,
                        name: '東京都千代田区'
                    });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            name: '現在地'
                        });
                    },
                    (error) => {
                        console.warn('⚠️ 位置情報取得失敗:', error.message);
                        resolve({
                            latitude: 35.6809591,
                            longitude: 139.7673068,
                            name: '東京都千代田区'
                        });
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Go back
        window.goBack = function () {
            window.location.href = 'kigo-gatcha.html';
        };

        // Initialize on load
        init();
    </script>
</body>

</html>
