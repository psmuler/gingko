<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ø≥Âè•„ÇíË©†„ÇÄ - ÂêüË°å</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- OGP Meta Tags -->
    <meta property="og:site_name" content="ÂêüË°å">
    <meta property="og:title" content="ÂêüË°å - ‰ø≥Âè•ÈëëË≥ûÔºÜË®òÈå≤„Ç¢„Éó„É™">
    <meta property="og:description" content="‰ø≥Âè•„ÉªÁü≠Ê≠å„ÅÆÂêçÂè•„ÇÜ„Åã„Çä„ÅÆÂú∞„ÇíÂ∑°„Çä„ÄÅ„Åù„ÅÆÂ†¥„ÅßË©†„Åæ„Çå„Åü‰ΩúÂìÅ„ÇíÈëëË≥û„Åß„Åç„Çã„Ç¢„Éó„É™">
    <meta property="og:image" content="https://psmuler.github.io/gingko/ogp.png">
    <meta property="og:image:width" content="2400">
    <meta property="og:image:height" content="1260">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://psmuler.github.io/gingko/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://psmuler.github.io/gingko/ogp.png">

    <link rel="stylesheet" href="css/styles.css">

    <!-- Supabase JavaScript SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1>‰ø≥Âè•„ÇíË©†„ÇÄ</h1>
                <p id="header-subtitle">ÈÅ∏„Çì„Å†Â≠£Ë™û: <span id="selected-kigo-display"></span></p>
            </div>
            <button class="menu-toggle" onclick="goBack()" style="width: 40px; height: 40px; background: transparent; border: none; color: white; font-size: 2rem; cursor: pointer; border-radius: 50%; transition: background 0.2s;">
                √ó
            </button>
        </header>

        <!-- Main Content -->
        <main style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; background: var(--secondary-color);">
            <div class="modal-content" style="max-width: 600px; width: 100%; padding: 30px;" id="form-container">
                <!-- Form will be dynamically generated by haiku-form-component.js -->
            </div>
        </main>
    </div>

    <!-- ES Module Scripts -->
    <script type="module">
        import './js/utils.js';
        import { initializeKigoSuggestions, getCurrentKigoSelection } from './js/kigo-suggestions.js';
        import { getSupabaseClient } from './js/supabase-client.js';
        import { apiAdapter } from './js/api-adapter.js';
        import { createHaikuForm, initializeKigoSuggestion } from './js/haiku-form-component.js';

        let selectedKigoFromGatcha = null;
        let editMode = false;
        let editingHaikuId = null;

        const utils = window.utils || {};
        const debounceFn = typeof utils.debounce === 'function' ? utils.debounce : (fn) => fn;
        const saveDraftToLocal = typeof utils.saveDraftToLocal === 'function' ? utils.saveDraftToLocal : null;
        const loadDraftFromLocal = typeof utils.loadDraftFromLocal === 'function' ? utils.loadDraftFromLocal : null;
        const clearDraftFromLocal = typeof utils.clearDraftFromLocal === 'function' ? utils.clearDraftFromLocal : null;
        const hasLocalStorageSupport = typeof utils.hasLocalStorageSupport === 'function'
            ? utils.hasLocalStorageSupport
            : () => false;
        const DRAFT_STORAGE_KEY = utils.DEFAULT_DRAFT_STORAGE_KEY || 'gingko_current_draft';
        const canUseDraftStorage = hasLocalStorageSupport();
        const draftStorageOptions = { key: DRAFT_STORAGE_KEY };

        let currentDraftLocation = null;
        let pendingLocationPromise = null;
        let draftRestored = false;

        // Initialize
        async function init() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const kigoParam = urlParams.get('kigo');
            const experiencedParam = urlParams.get('experienced');
            const editParam = urlParams.get('edit');

            // Update header subtitle based on source
            const headerSubtitle = document.getElementById('header-subtitle');

            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂà§ÂÆö
            if (editParam) {
                editMode = true;
                editingHaikuId = parseInt(editParam);

                // „Éò„ÉÉ„ÉÄ„ÉºÂ§âÊõ¥
                const headerTitle = document.querySelector('header h1');
                if (headerTitle) {
                    headerTitle.textContent = '‰ø≥Âè•„ÇíÁ∑®ÈõÜ';
                }
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            } else if (experiencedParam === 'true') {
                // Experienced user - hide kigo display
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            } else if (kigoParam) {
                selectedKigoFromGatcha = {
                    kigo: decodeURIComponent(kigoParam),
                    season: urlParams.get('season') || null,
                    seasonJa: urlParams.get('seasonJa') || null
                };

                // Display selected kigo
                const displayElement = document.getElementById('selected-kigo-display');
                if (displayElement) {
                    displayElement.textContent = `${selectedKigoFromGatcha.kigo}Ôºà${selectedKigoFromGatcha.seasonJa || ''}Ôºâ`;
                }
            } else {
                // No kigo parameter - hide subtitle
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            }

            // Generate form using component
            const formContainer = document.getElementById('form-container');
            if (formContainer) {
                // Determine placeholder based on source
                let placeholder;
                if (editMode) {
                    placeholder = 'Ë™≠„ÅøËæº„Åø‰∏≠...';
                } else if (experiencedParam === 'true') {
                    placeholder = '‰∏ÄÁï™ÊúÄËøëË©†„Çì„Å†Âè•„ÅØ';
                } else if (selectedKigoFromGatcha) {
                    placeholder = selectedKigoFromGatcha.kigo;
                } else {
                    placeholder = 'ÊñßÂÖ•„Çå„Å¶È¶ô„Å´È©ö„Åè„ÇÑÂÜ¨Êú®Á´ã';
                }

                const formHTML = createHaikuForm({
                    formId: 'haiku-compose-form',
                    textAreaId: 'haiku-text',
                    suggestionsId: 'kigo-suggestions',
                    showPoetField: true,
                    showHeader: false,
                    showSwipeIndicator: false,
                    submitButtonText: editMode ? 'Êõ¥Êñ∞„Åô„Çã' : 'Ë©†„Çì„Å†ÔºÅ',
                    placeholder: placeholder
                });
                formContainer.innerHTML = formHTML;

                // Setup form submit handler
                const form = document.getElementById('haiku-compose-form');
                if (form) {
                    form.addEventListener('submit', submitHaiku);
                }

                console.log('‚úÖ „Éï„Ç©„Éº„É†ÁîüÊàêÂÆå‰∫Ü (componentÂåñ)');
            }

            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅÊó¢Â≠ò„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
            if (editMode && editingHaikuId) {
                await loadHaikuForEdit(editingHaikuId);
            }

            await maybeRestoreDraft();

            setupDraftAutoSave();

            // Initialize kigo suggestion feature
            try {
                await initializeKigoSuggestions();
                await initializeKigoSuggestion('haiku-text', 'kigo-suggestions');
                console.log('‚úÖ Â≠£Ë™û„Çµ„Ç∏„Çß„Çπ„ÉàÊ©üËÉΩÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('‚ùå Â≠£Ë™û„Çµ„Ç∏„Çß„Çπ„ÉàÊ©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }

        function setupDraftAutoSave() {
            if (!canUseDraftStorage || !saveDraftToLocal || !loadDraftFromLocal || !clearDraftFromLocal) {
                return;
            }

            const textArea = document.getElementById('haiku-text');
            const poetInput = document.getElementById('poet-name');

            if (!textArea) {
                console.warn('‚ö†Ô∏è Draft auto-save unavailable: textarea not found');
                return;
            }

            const debouncedSave = debounceFn(async () => {
                const textValue = textArea.value;
                const trimmedText = textValue.trim();

                if (!trimmedText) {
                    clearDraftFromLocal && clearDraftFromLocal(draftStorageOptions);
                    return;
                }

                const location = await ensureDraftLocation();

                const draftContext = editMode ? 'compose-edit' : 'compose';

                saveDraftToLocal({
                    text: trimmedText,
                    rawText: textValue,
                    poetName: poetInput ? poetInput.value.trim() : '',
                    location,
                    mode: editMode ? 'edit' : 'create',
                    haikuId: editMode ? editingHaikuId : null,
                    context: draftContext
                }, draftStorageOptions);
            }, 300);

            textArea.addEventListener('input', debouncedSave);
            if (poetInput) {
                poetInput.addEventListener('input', debouncedSave);
            }

            if (draftRestored) {
                debouncedSave();
            }
        }

        async function ensureDraftLocation() {
            if (currentDraftLocation) {
                return currentDraftLocation;
            }

            if (pendingLocationPromise) {
                return pendingLocationPromise;
            }

            pendingLocationPromise = getCurrentLocationOrDefault()
                .then((location) => {
                    currentDraftLocation = location;
                    return location;
                })
                .catch((error) => {
                    console.warn('‚ö†Ô∏è Failed to obtain location for draft storage:', error);
                    return null;
                })
                .finally(() => {
                    pendingLocationPromise = null;
                });

            return pendingLocationPromise;
        }

        async function maybeRestoreDraft() {
            if (!canUseDraftStorage || !loadDraftFromLocal) {
                return;
            }

            const storedDraft = loadDraftFromLocal(draftStorageOptions);
            if (!storedDraft || !storedDraft.text) {
                return;
            }

            const expectedContext = editMode ? 'compose-edit' : 'compose';

            if (storedDraft.context && storedDraft.context !== expectedContext) {
                return;
            }

            if (editMode) {
                if (storedDraft.mode !== 'edit' || storedDraft.haikuId !== editingHaikuId) {
                    return;
                }
            } else if (storedDraft.mode === 'edit') {
                return;
            }

            const shouldRestore = confirm('ÂâçÂõû„ÅÆÂÖ•Âäõ„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü');
            if (!shouldRestore) {
                clearDraftFromLocal && clearDraftFromLocal(draftStorageOptions);
                return;
            }

            const textArea = document.getElementById('haiku-text');
            const poetInput = document.getElementById('poet-name');

            if (textArea) {
                textArea.value = storedDraft.rawText || storedDraft.text || '';
            }

            if (poetInput && storedDraft.poetName) {
                poetInput.value = storedDraft.poetName;
            }

            if (storedDraft.location) {
                currentDraftLocation = storedDraft.location;
            }

            draftRestored = true;
        }

        // Load haiku data for editing
        async function loadHaikuForEdit(haikuId) {
            try {
                console.log(`üìñ ‰ø≥Âè•„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠: ID=${haikuId}`);
                const haiku = await apiAdapter.getHaiku(haikuId);

                if (!haiku) {
                    throw new Error('‰ø≥Âè•„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }

                // „Éï„Ç©„Éº„É†„Å´„Éá„Éº„Çø„ÇíË®≠ÂÆö
                const haikuTextArea = document.getElementById('haiku-text');
                const poetNameInput = document.getElementById('poet-name');

                if (haikuTextArea) {
                    haikuTextArea.value = haiku.haiku_text || '';
                }

                if (poetNameInput) {
                    poetNameInput.value = haiku.poet_name || '';
                }

                console.log('‚úÖ ‰ø≥Âè•„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', haiku);
            } catch (error) {
                console.error('‚ùå ‰ø≥Âè•„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                alert('‰ø≥Âè•„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                window.location.href = 'home.html';
            }
        }

        // Submit haiku
        window.submitHaiku = async function (event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-haiku-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = editMode ? 'Êõ¥Êñ∞‰∏≠...' : 'ÊäïÁ®ø‰∏≠...';

            try {
                // Get form data
                const haikuText = document.getElementById('haiku-text').value;
                const poetName = document.getElementById('poet-name').value;

                // Get kigo selection
                const kigoSelection = getCurrentKigoSelection();

                // Get or create poet_id
                let poetId = null;

                if (poetName && poetName !== 'Ë©†„Åø‰∫∫Áü•„Çâ„Åö') {
                    const existingPoets = await apiAdapter.searchPoets(poetName);
                    if (existingPoets && existingPoets.length > 0) {
                        poetId = existingPoets[0].id;
                    }
                }

                // Prepare haiku data
                const haikuData = {
                    haiku_text: haikuText,
                    poet_id: poetId,
                    season: kigoSelection.season || null,
                    seasonal_term: kigoSelection.selectedKigo?.display_name || null
                };

                // Á∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂê´„ÇÅ„Å™„ÅÑÔºàÊó¢Â≠ò„ÅÆ„Åæ„ÅæÔºâ
                if (!editMode) {
                    // Get current location or use default
                    const location = await getCurrentLocationOrDefault();
                    haikuData.latitude = location.latitude;
                    haikuData.longitude = location.longitude;
                    haikuData.location_name = location.name;
                    haikuData.location_type = '„ÇÜ„Åã„Çä„ÅÆÂú∞';
                }

                console.log(`üì§ ${editMode ? 'Êõ¥Êñ∞' : 'ÊäïÁ®ø'}„Éá„Éº„Çø:`, haikuData);

                // Submit or update using API adapter
                let result;
                if (editMode) {
                    result = await apiAdapter.updateHaiku(editingHaikuId, haikuData);
                } else {
                    result = await apiAdapter.createHaiku(haikuData);
                }

                if (!result.success) {
                    throw new Error(`${editMode ? 'Êõ¥Êñ∞' : 'ÊäïÁ®ø'}„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`);
                }

                console.log(`‚úÖ ${editMode ? 'Êõ¥Êñ∞' : 'ÊäïÁ®ø'}ÊàêÂäü:`, result);
                if (clearDraftFromLocal) {
                    clearDraftFromLocal(draftStorageOptions);
                }

                alert(`‰ø≥Âè•„Çí${editMode ? 'Êõ¥Êñ∞' : 'ÊäïÁ®ø'}„Åó„Åæ„Åó„ÅüÔºÅ`);

                // Redirect to home
                window.location.href = 'home.html';

            } catch (error) {
                console.error(`‚ùå ${editMode ? 'Êõ¥Êñ∞' : 'ÊäïÁ®ø'}„Ç®„É©„Éº:`, error);
                alert(`${editMode ? 'Êõ¥Êñ∞' : 'ÊäïÁ®ø'}„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                submitBtn.disabled = false;
                submitBtn.textContent = editMode ? 'Êõ¥Êñ∞„Åô„Çã' : 'Ë©†„Çì„Å†ÔºÅ';
            }
        };

        // Get current location or use default (Tokyo)
        async function getCurrentLocationOrDefault() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ');
                    resolve({
                        latitude: 35.6809591,
                        longitude: 139.7673068,
                        name: 'Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫'
                    });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            name: 'ÁèæÂú®Âú∞'
                        });
                    },
                    (error) => {
                        console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó:', error.message);
                        resolve({
                            latitude: 35.6809591,
                            longitude: 139.7673068,
                            name: 'Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫'
                        });
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Go back
        window.goBack = function () {
            window.location.href = 'kigo-gatcha.html';
        };

        // Initialize on load
        init();
    </script>
</body>

</html>
