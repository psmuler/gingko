<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ø≥Âè•„ÇíË©†„ÇÄ - ÂêüË°å</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Supabase JavaScript SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1>‰ø≥Âè•„ÇíË©†„ÇÄ</h1>
                <p>ÈÅ∏„Çì„Å†Â≠£Ë™û: <span id="selected-kigo-display"></span></p>
            </div>
            <button class="menu-toggle" onclick="goBack()" style="width: 40px; height: 40px; background: transparent; border: none; color: white; font-size: 2rem; cursor: pointer; border-radius: 50%; transition: background 0.2s;">
                √ó
            </button>
        </header>

        <!-- Main Content -->
        <main style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; background: var(--secondary-color);">
            <div class="modal-content" style="max-width: 600px; width: 100%; padding: 30px;">
                <form id="haiku-compose-form">
                    <div class="form-group">
                        <label for="haiku-text">‰ø≥Âè•</label>
                        <textarea id="haiku-text" name="haiku_text" required
                            placeholder="Âè§Ê±†„ÇÑ&#10;ËõôÈ£õ„Å≥Ëæº„ÇÄ&#10;Ê∞¥„ÅÆÈü≥"></textarea>
                    </div>

                    <!-- Kigo suggestions area -->
                    <div id="kigo-suggestions" class="kigo-suggestions"></div>

                    <div class="form-group">
                        <label for="poet-name">Ë©†„Åø‰∫∫</label>
                        <input type="text" id="poet-name" name="poet_name" required placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç">
                    </div>

                    <!-- Hidden fields for kigo data -->
                    <input type="hidden" id="inline-season" name="season">
                    <input type="hidden" id="inline-seasonal-term" name="seasonal_term">
                    <input type="hidden" id="inline-keyword-id" name="keyword_id">

                    <div class="form-actions">
                        <button type="submit" class="primary-btn" id="submit-haiku-btn">Ë©†„Çì„Å†ÔºÅ</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- ES Module Scripts -->
    <script type="module">
        import { initializeKigoSuggestions, attachKigoSuggestionToInput, getCurrentKigoSelection } from './js/kigo-suggestions.js';
        import { getSupabaseClient } from './js/supabase-client.js';
        import { apiAdapter } from './js/api-adapter.js';

        let selectedKigoFromGatcha = null;

        // Initialize
        async function init() {
            // Get kigo from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const kigoParam = urlParams.get('kigo');

            if (kigoParam) {
                selectedKigoFromGatcha = {
                    kigo: decodeURIComponent(kigoParam),
                    season: urlParams.get('season') || null,
                    seasonJa: urlParams.get('seasonJa') || null
                };

                // Display selected kigo
                const displayElement = document.getElementById('selected-kigo-display');
                if (displayElement) {
                    displayElement.textContent = `${selectedKigoFromGatcha.kigo}Ôºà${selectedKigoFromGatcha.seasonJa || ''}Ôºâ`;
                }
            }

            // Initialize kigo suggestion feature
            try {
                await initializeKigoSuggestions();
                attachKigoSuggestionToInput('haiku-text', 'kigo-suggestions');
                console.log('‚úÖ Â≠£Ë™û„Çµ„Ç∏„Çß„Çπ„ÉàÊ©üËÉΩÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('‚ùå Â≠£Ë™û„Çµ„Ç∏„Çß„Çπ„ÉàÊ©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }

        // Submit haiku
        window.submitHaiku = async function (event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-haiku-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ÊäïÁ®ø‰∏≠...';

            try {
                // Get form data
                const haikuText = document.getElementById('haiku-text').value;
                const poetName = document.getElementById('poet-name').value;

                // Get kigo selection
                const kigoSelection = getCurrentKigoSelection();

                // Get current location or use default
                const location = await getCurrentLocationOrDefault();

                // Get or create poet_id
                let poetId = null;

                if (poetName && poetName !== 'Ë©†„Åø‰∫∫Áü•„Çâ„Åö') {
                    const existingPoets = await apiAdapter.searchPoets(poetName);
                    if (existingPoets && existingPoets.length > 0) {
                        poetId = existingPoets[0].id;
                    }
                }

                // Prepare haiku data (using correct schema)
                const haikuData = {
                    haiku_text: haikuText,
                    poet_id: poetId,
                    latitude: location.latitude,
                    longitude: location.longitude,
                    location_name: location.name,
                    location_type: '„ÇÜ„Åã„Çä„ÅÆÂú∞',
                    season: kigoSelection.season || null,
                    seasonal_term: kigoSelection.selectedKigo?.display_name || null
                };

                console.log('üì§ ÊäïÁ®ø„Éá„Éº„Çø:', haikuData);

                // Submit using API adapter
                const result = await apiAdapter.createHaiku(haikuData);

                if (!result.success) {
                    throw new Error('ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                console.log('‚úÖ ÊäïÁ®øÊàêÂäü:', result);
                alert('‰ø≥Âè•„ÇíÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ');

                // Redirect to home
                window.location.href = 'home.html';

            } catch (error) {
                console.error('‚ùå ÊäïÁ®ø„Ç®„É©„Éº:', error);
                alert('ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Ë©†„Çì„Å†ÔºÅ';
            }
        };

        // Get current location or use default (Tokyo)
        async function getCurrentLocationOrDefault() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ');
                    resolve({
                        latitude: 35.6809591,
                        longitude: 139.7673068,
                        name: 'Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫'
                    });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            name: 'ÁèæÂú®Âú∞'
                        });
                    },
                    (error) => {
                        console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó:', error.message);
                        resolve({
                            latitude: 35.6809591,
                            longitude: 139.7673068,
                            name: 'Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫'
                        });
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Go back
        window.goBack = function () {
            window.location.href = 'kigo-gatcha.html';
        };

        // Attach form submit handler
        document.getElementById('haiku-compose-form').addEventListener('submit', submitHaiku);

        // Initialize on load
        init();
    </script>
</body>

</html>
