<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ø≥Âè•„ÇíË©†„ÇÄ - ÂêüË°å</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- OGP Meta Tags -->
    <meta property="og:title" content="ÂêüË°å - ‰ø≥Âè•ÈëëË≥ûÔºÜË®òÈå≤„Ç¢„Éó„É™">
    <meta property="og:description" content="‰ø≥Âè•„ÉªÁü≠Ê≠å„ÅÆÂêçÂè•„ÇÜ„Åã„Çä„ÅÆÂú∞„ÇíÂ∑°„Çä„ÄÅ„Åù„ÅÆÂ†¥„ÅßË©†„Åæ„Çå„Åü‰ΩúÂìÅ„ÇíÈëëË≥û„Åß„Åç„Çã„Ç¢„Éó„É™">
    <meta property="og:image" content="https://ti-haiku.github.io/ginkou/ogp.png">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ti-haiku.github.io/ginkou/">
    <meta name="twitter:card" content="summary_large_image">

    <link rel="stylesheet" href="css/styles.css">

    <!-- Supabase JavaScript SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1>‰ø≥Âè•„ÇíË©†„ÇÄ</h1>
                <p id="header-subtitle">ÈÅ∏„Çì„Å†Â≠£Ë™û: <span id="selected-kigo-display"></span></p>
            </div>
            <button class="menu-toggle" onclick="goBack()" style="width: 40px; height: 40px; background: transparent; border: none; color: white; font-size: 2rem; cursor: pointer; border-radius: 50%; transition: background 0.2s;">
                √ó
            </button>
        </header>

        <!-- Main Content -->
        <main style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; background: var(--secondary-color);">
            <div class="modal-content" style="max-width: 600px; width: 100%; padding: 30px;" id="form-container">
                <!-- Form will be dynamically generated by haiku-form-component.js -->
            </div>
        </main>
    </div>

    <!-- ES Module Scripts -->
    <script type="module">
        import { initializeKigoSuggestions, getCurrentKigoSelection } from './js/kigo-suggestions.js';
        import { getSupabaseClient } from './js/supabase-client.js';
        import { apiAdapter } from './js/api-adapter.js';
        import { createHaikuForm, initializeKigoSuggestion } from './js/haiku-form-component.js';

        let selectedKigoFromGatcha = null;

        // Initialize
        async function init() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const kigoParam = urlParams.get('kigo');
            const experiencedParam = urlParams.get('experienced');

            // Update header subtitle based on source
            const headerSubtitle = document.getElementById('header-subtitle');

            if (experiencedParam === 'true') {
                // Experienced user - hide kigo display
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            } else if (kigoParam) {
                selectedKigoFromGatcha = {
                    kigo: decodeURIComponent(kigoParam),
                    season: urlParams.get('season') || null,
                    seasonJa: urlParams.get('seasonJa') || null
                };

                // Display selected kigo
                const displayElement = document.getElementById('selected-kigo-display');
                if (displayElement) {
                    displayElement.textContent = `${selectedKigoFromGatcha.kigo}Ôºà${selectedKigoFromGatcha.seasonJa || ''}Ôºâ`;
                }
            } else {
                // No kigo parameter - hide subtitle
                if (headerSubtitle) {
                    headerSubtitle.style.display = 'none';
                }
            }

            // Generate form using component
            const formContainer = document.getElementById('form-container');
            if (formContainer) {
                // Determine placeholder based on source
                let placeholder;
                if (experiencedParam === 'true') {
                    placeholder = '‰∏ÄÁï™ÊúÄËøëË©†„Çì„Å†Âè•„ÅØ';
                } else if (selectedKigoFromGatcha) {
                    placeholder = selectedKigoFromGatcha.kigo;
                } else {
                    placeholder = 'ÊñßÂÖ•„Çå„Å¶È¶ô„Å´È©ö„Åè„ÇÑÂÜ¨Êú®Á´ã';
                }

                const formHTML = createHaikuForm({
                    formId: 'haiku-compose-form',
                    textAreaId: 'haiku-text',
                    suggestionsId: 'kigo-suggestions',
                    showPoetField: true,
                    showHeader: false,
                    showSwipeIndicator: false,
                    submitButtonText: 'Ë©†„Çì„Å†ÔºÅ',
                    placeholder: placeholder
                });
                formContainer.innerHTML = formHTML;

                // Setup form submit handler
                const form = document.getElementById('haiku-compose-form');
                if (form) {
                    form.addEventListener('submit', submitHaiku);
                }

                console.log('‚úÖ „Éï„Ç©„Éº„É†ÁîüÊàêÂÆå‰∫Ü (componentÂåñ)');
            }

            // Initialize kigo suggestion feature
            try {
                await initializeKigoSuggestions();
                await initializeKigoSuggestion('haiku-text', 'kigo-suggestions');
                console.log('‚úÖ Â≠£Ë™û„Çµ„Ç∏„Çß„Çπ„ÉàÊ©üËÉΩÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('‚ùå Â≠£Ë™û„Çµ„Ç∏„Çß„Çπ„ÉàÊ©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }

        // Submit haiku
        window.submitHaiku = async function (event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-haiku-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ÊäïÁ®ø‰∏≠...';

            try {
                // Get form data
                const haikuText = document.getElementById('haiku-text').value;
                const poetName = document.getElementById('poet-name').value;

                // Get kigo selection
                const kigoSelection = getCurrentKigoSelection();

                // Get current location or use default
                const location = await getCurrentLocationOrDefault();

                // Get or create poet_id
                let poetId = null;

                if (poetName && poetName !== 'Ë©†„Åø‰∫∫Áü•„Çâ„Åö') {
                    const existingPoets = await apiAdapter.searchPoets(poetName);
                    if (existingPoets && existingPoets.length > 0) {
                        poetId = existingPoets[0].id;
                    }
                }

                // Prepare haiku data (using correct schema)
                const haikuData = {
                    haiku_text: haikuText,
                    poet_id: poetId,
                    latitude: location.latitude,
                    longitude: location.longitude,
                    location_name: location.name,
                    location_type: '„ÇÜ„Åã„Çä„ÅÆÂú∞',
                    season: kigoSelection.season || null,
                    seasonal_term: kigoSelection.selectedKigo?.display_name || null
                };

                console.log('üì§ ÊäïÁ®ø„Éá„Éº„Çø:', haikuData);

                // Submit using API adapter
                const result = await apiAdapter.createHaiku(haikuData);

                if (!result.success) {
                    throw new Error('ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                console.log('‚úÖ ÊäïÁ®øÊàêÂäü:', result);
                alert('‰ø≥Âè•„ÇíÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ');

                // Redirect to home
                window.location.href = 'home.html';

            } catch (error) {
                console.error('‚ùå ÊäïÁ®ø„Ç®„É©„Éº:', error);
                alert('ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Ë©†„Çì„Å†ÔºÅ';
            }
        };

        // Get current location or use default (Tokyo)
        async function getCurrentLocationOrDefault() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ');
                    resolve({
                        latitude: 35.6809591,
                        longitude: 139.7673068,
                        name: 'Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫'
                    });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            name: 'ÁèæÂú®Âú∞'
                        });
                    },
                    (error) => {
                        console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó:', error.message);
                        resolve({
                            latitude: 35.6809591,
                            longitude: 139.7673068,
                            name: 'Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫'
                        });
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Go back
        window.goBack = function () {
            window.location.href = 'kigo-gatcha.html';
        };

        // Initialize on load
        init();
    </script>
</body>

</html>
