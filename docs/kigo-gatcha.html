<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­£èªã‚¬ãƒãƒ£ - ä¿³å¥é‘‘è³ï¼†è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/kigo-gatcha.css">
</head>

<body>
    <div id="app">
        <!-- Welcome Screen (åˆå›è¨ªå•æ™‚ã®ã¿) -->
        <div id="welcome-screen" class="welcome-screen" style="display: none;">
            <div class="welcome-content">
                <h1>åŸè¡Œ</h1>
                <p class="welcome-subtitle">ä¿³å¥ã¯ã€</p>
                <div class="welcome-buttons">
                    <button class="welcome-btn experienced-btn" onclick="handleExperienced()">
                        æ™®æ®µã‹ã‚‰è© ã‚“ã§ã‚‹
                    </button>
                    <button class="welcome-btn beginner-btn" onclick="handleBeginner()">
                        åˆã‚ã¦ï¼
                    </button>
                </div>
            </div>
        </div>

        <!-- Kigo Gatcha Screen -->
        <div id="gatcha-screen" class="gatcha-screen" style="display: none;">
            <header>
                <div class="header-content">
                    <h1>å­£èªã‚¬ãƒãƒ£</h1>
                    <p id="season-display">ä»Šã¯<span id="current-season"></span>ã®å­£ç¯€</p>
                </div>
                <button class="back-btn" onclick="goToTop()">Ã—</button>
            </header>

            <main class="gatcha-main">
                <!-- Beginner Explanation (åˆå›ã®ã¿) -->
                <div id="beginner-explanation" class="beginner-explanation" style="display: none;">
                    <p>ä¿³å¥ã«ã¯ã€Œå­£èªã€ã¨ã„ã†å­£ç¯€ã‚’è¡¨ã™è¨€è‘‰ãŒä½¿ã‚ã‚Œã¾ã™ã€‚</p>
                    <p>ã¾ãšã¯å­£èªã‚’ä¸€ã¤é¸ã‚“ã§ã€ãã‚Œã‚’ä½¿ã£ã¦ä¿³å¥ã‚’è© ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼</p>
                </div>

                <!-- Gatcha Result Area -->
                <div id="gatcha-result" class="gatcha-result" style="display: none;">
                    <div class="kigo-display">
                        <p class="kigo-label">å­£èª</p>
                        <h2 id="kigo-text" class="kigo-text"></h2>
                        <p class="season-label">(<span id="kigo-season"></span>)</p>
                    </div>

                    <div class="gatcha-actions">
                        <button class="action-btn secondary-btn" onclick="rollAgain()">
                            ã‚„ã‚Šç›´ã™
                        </button>
                        <button class="action-btn primary-btn" onclick="proceedToHaikuInput()">
                            æ¬¡ã¸
                        </button>
                    </div>
                </div>

                <!-- Initial Gatcha Button -->
                <div id="gatcha-button-area" class="gatcha-button-area">
                    <button id="gatcha-btn" class="gatcha-btn" onclick="performGatcha()">
                        ğŸ² å­£èªã‚¬ãƒãƒ£ ã‚’å¼•ã
                    </button>
                    <p class="gatcha-hint">ä»Šã®å­£ç¯€ã®å­£èªãŒãƒ©ãƒ³ãƒ€ãƒ ã§é¸ã°ã‚Œã¾ã™</p>
                </div>

                <!-- All Used Message -->
                <div id="all-used-message" class="all-used-message" style="display: none;">
                    <p>ã™ã¹ã¦ã®å­£èªã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸï¼</p>
                    <button class="reset-btn" onclick="resetAndGatcha()">æœ€åˆã‹ã‚‰</button>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import {
            getCurrentSeason,
            getSeasonNameJa,
            getRandomKigo,
            getUsedKigo,
            addUsedKigo,
            resetUsedKigo,
            isFirstVisit,
            markVisited,
            getSeasonColor
        } from './js/kigo-gatcha-logic.js';

        let currentKigo = null;

        // Initialize app
        function init() {
            if (isFirstVisit()) {
                showWelcomeScreen();
            } else {
                showGatchaScreen();
            }
            updateSeasonDisplay();
        }

        // Show welcome screen
        function showWelcomeScreen() {
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('gatcha-screen').style.display = 'none';
        }

        // Show gatcha screen
        function showGatchaScreen() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('gatcha-screen').style.display = 'block';
            document.getElementById('beginner-explanation').style.display = 'none';
            document.getElementById('gatcha-result').style.display = 'none';
            document.getElementById('gatcha-button-area').style.display = 'block';
        }

        // Handle "experienced" user
        window.handleExperienced = function() {
            markVisited();
            window.location.href = 'index.html';
        };

        // Handle "beginner" user
        window.handleBeginner = function() {
            markVisited();
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('gatcha-screen').style.display = 'block';
            document.getElementById('beginner-explanation').style.display = 'block';
            document.getElementById('gatcha-result').style.display = 'none';
            document.getElementById('gatcha-button-area').style.display = 'block';
        };

        // Update season display
        function updateSeasonDisplay() {
            const season = getCurrentSeason();
            const seasonJa = getSeasonNameJa(season);
            const seasonElement = document.getElementById('current-season');
            if (seasonElement) {
                seasonElement.textContent = seasonJa;
                seasonElement.style.color = getSeasonColor(season);
            }

            // Update gatcha button color
            const gatchaBtn = document.getElementById('gatcha-btn');
            if (gatchaBtn) {
                gatchaBtn.style.backgroundColor = getSeasonColor(season);
            }
        }

        // Perform gatcha
        window.performGatcha = function() {
            const usedKigo = getUsedKigo();
            const result = getRandomKigo(usedKigo);

            if (result === null) {
                // All kigo used
                document.getElementById('gatcha-button-area').style.display = 'none';
                document.getElementById('gatcha-result').style.display = 'none';
                document.getElementById('all-used-message').style.display = 'block';
                return;
            }

            currentKigo = result;
            addUsedKigo(result.kigo);

            // Display result
            document.getElementById('kigo-text').textContent = result.kigo;
            document.getElementById('kigo-season').textContent = result.seasonJa;
            document.getElementById('beginner-explanation').style.display = 'none';
            document.getElementById('gatcha-button-area').style.display = 'none';
            document.getElementById('gatcha-result').style.display = 'block';
        };

        // Roll again
        window.rollAgain = function() {
            document.getElementById('gatcha-result').style.display = 'none';
            document.getElementById('gatcha-button-area').style.display = 'block';
            currentKigo = null;
        };

        // Reset and gatcha
        window.resetAndGatcha = function() {
            resetUsedKigo();
            document.getElementById('all-used-message').style.display = 'none';
            document.getElementById('gatcha-button-area').style.display = 'block';
        };

        // Proceed to haiku input
        window.proceedToHaikuInput = function() {
            if (currentKigo) {
                // Store selected kigo in sessionStorage for haiku input screen
                sessionStorage.setItem('selectedKigo', JSON.stringify(currentKigo));
                // Navigate to haiku input (integration with existing app)
                window.location.href = 'index.html?mode=compose&kigo=' + encodeURIComponent(currentKigo.kigo);
            }
        };

        // Go to top
        window.goToTop = function() {
            window.location.href = 'index.html';
        };

        // Initialize on load
        init();
    </script>
</body>

</html>
