# CLAUDE.md - ピン投稿UI改善仕様

## 概要

俳句投稿UIを従来のボタン式から地図上でのピン投稿方式に改善し、より直感的で使いやすいインターフェースを提供する。

## 基本操作フロー

### 地図タップ時の動作
```
地図タップ
    ↓
既存ピン判定
    ├─ 既存ピンあり → 既存俳句をピン上にポップアップ表示
    └─ 既存ピンなし → 一時ピンを配置 + 画面下部に新規俳句入力フォーム表示
```

### ピン配置仕様
- **配置精度**: タップした正確な位置に配置
- **位置変更**: タップ毎に位置更新、入力内容は保持
- **一時ピン制限**: 同時に1つのみ配置可能
- **既存ピン優先**: 既存ピンエリアをタップした場合は一時ピンを削除し既存俳句を表示

## 入力インターフェース設計

### 二段階入力システム

#### 標準入力画面（画面下部スライドアップ）
```
┌─────────────────────┐
│                     │ ← 地図エリア
│       🗺️地図        │
│                     │
├─────────────────────┤
│ 俳句: [テキストボックス] │ ← スライドアップフォーム
│ [投稿] [キャンセル]     │
└─────────────────────┘
```

**含まれる項目**:
- 俳句本文（必須）
- 投稿ボタン
- キャンセルボタン

#### 詳細入力画面（フルスクリーン）
**遷移方法**:
- モバイル: フォームを上方向にスワイプ
- PC: フォーム上でスクロール または フォーム外をダブルクリック

**含まれる項目**:
- 既存フォームの全項目
- 詠み人情報
- 場所情報
- 季節・季語情報
- 日付情報

### モダンUIの特徴
- **スムーズアニメーション**: 画面下部からのスライドアップ
- **レスポンシブデザイン**: 画面サイズに応じた最適化
- **直感的操作**: ジェスチャーベースの画面遷移

## ピン管理システム

### 一時ピン（新規投稿用）
```javascript
const temporaryPin = {
  type: "temporary",
  position: [latitude, longitude],
  status: "editing",
  data: {
    haiku_text: "",
    // ... 入力データ
  }
};
```

### 既存ピン
```javascript
const existingPin = {
  type: "existing", 
  position: [latitude, longitude],
  status: "published",
  season: "春", // 季節による色分け
  data: {
    // 既存の俳句データ
  }
};
```

### ピン操作フロー
1. **配置**: 地図タップ → 一時ピン生成
2. **移動**: 再タップ → ピン位置更新
3. **削除**: キャンセル → 確認プロンプト → 削除
4. **投稿**: 投稿ボタン → 既存ピンに変換

## 視覚デザイン仕様

### ピンデザイン

#### 一時ピン（入力中）
```
 ╲_____╱
╱       ╲
╲       ╱
 ╱     ╲
  ╱   ╲
   ╲ ╱
    ●
```
- **形状**: 涙型（水滴型、先端が下向き）
- **色**: グレー系（未確定を表現）
- **サイズ**: 小さめ表示
- **アニメーション**: 軽微なパルス効果

#### 既存ピン（投稿済み）
```
 ╲_____╱
╱       ╲
╲       ╱
 ╱     ╲
  ╱   ╲
   ╲ ╱
    ●
```
- **形状**: 一時ピンと同じ涙型（先端下向き）
- **色**: 季節による塗り分け
  - 春: #3498db（青）
  - 夏: #e74c3c（赤）  
  - 秋: #ffffff（白）
  - 冬: #2c3e50（黒）
  - 暮・新年: #f1c40f（黄）
  - その他: #95a5a6（グレー）
- **サイズ**: 小さめ表示

### 現在地ボタン
```
  ┌─┐
  │ │
┌─┼─┼─┐
│ │ │ │  ← Google Maps風の十字アイコン
└─┼─┼─┘
  │ │
  └─┘
```
- **デザイン**: Google Maps風の十字型ナビゲーションアイコン
- **配置**: 地図上の固定位置（右下など）
- **機能**: 現在地に地図を移動

## 画面遷移・表示仕様

### 即座性を重視したタップ判定システム

#### 優先順位に基づく処理フロー
```
地図タップ
├─ 【最優先】ポップアップ開いている場合
│   └─ 即座にポップアップ閉じ（0ms、他の処理なし）
├─ 【優先2】既存マーカー近辺（判定半径50px）
│   └─ 即座にポップアップ表示（50ms以内）
└─ 【優先3】空白エリア
    └─ 即座に一時ピン配置 + フォーム表示（100ms以内）
```

### レスポンス時間目標
- **ポップアップ閉じ**: 0ms（即座実行）
- **既存俳句表示**: 50ms以内
- **新規フォーム表示**: 100ms以内
- **デバウンス遅延**: 50ms（従来300msから短縮）

### 既存俳句表示
```
既存マーカータップ
    ↓ 即座処理（イベント伝播停止）
ポップアップ表示
    ├─ 俳句本文
    ├─ 詠み人
    ├─ [詳細を見る]ボタン
    └─ [閉じる]ボタン
        ↓ 詳細を見る
    フルスクリーン詳細画面
```

### 新規俳句入力
```
空白エリアタップ
    ↓ 高速判定（キャッシュ活用）
一時ピン配置 + 画面下部フォーム表示
    ├─ 俳句入力
    ├─ [投稿]ボタン
    └─ [キャンセル]ボタン
        ↓ 上スワイプ/ダブルクリック
    詳細入力画面（フルスクリーン）
```

### パフォーマンス最適化
- **メモリキャッシュ**: 既存俳句データの高速検索
- **座標インデックス**: 空間検索の最適化
- **イベント分離**: マーカーと地図クリックの独立処理

## モバイル対応

### タッチ操作の最適化
- **タップ判定**: 適切なタッチ領域の確保
- **パン/ズーム競合回避**: タップとドラッグの明確な区別
- **レスポンシブレイアウト**: 画面サイズに応じたフォームサイズ調整

### ジェスチャー仕様
```javascript
const gestureHandling = {
  tap: "ピン配置/既存ピン表示",
  swipeUp: "詳細入力画面への遷移", 
  swipeDown: "フォーム閉じる",
  pan: "地図移動",
  pinch: "地図ズーム"
};
```

## 実装上の技術仕様

### 状態管理
```javascript
const uiState = {
  mode: "viewing", // "viewing" | "editing" | "detail"
  temporaryPin: null,
  activeForm: null,
  selectedHaiku: null
};
```

### イベントハンドリング
```javascript
// 地図タップ処理
map.on('click', function(e) {
  const clickedPin = checkExistingPin(e.latlng);
  
  if (clickedPin) {
    showExistingHaiku(clickedPin);
    removeTemporaryPin();
  } else {
    createTemporaryPin(e.latlng);
    showInputForm();
  }
});
```

### アニメーション仕様
```css
/* スライドアップアニメーション */
.slide-up-form {
  transform: translateY(100%);
  transition: transform 0.3s ease-out;
}

.slide-up-form.active {
  transform: translateY(0);
}

/* ピンアニメーション */
.temporary-pin {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
```

## 開発フェーズ分割

### Phase 1: 基本ピン投稿機能
- 地図タップでの一時ピン配置
- 画面下部での簡易俳句入力
- 基本的な投稿・キャンセル機能

### Phase 2: UI/UX改善
- スライドアップアニメーション
- ピンデザインの改善
- 現在地ボタンのリデザイン

### Phase 3: 詳細機能
- スワイプによる詳細入力画面
- クラスタ表示機能
- 高度なアニメーション

### Phase 4: パフォーマンス・最適化
- レスポンシブ対応の完成
- パフォーマンス最適化
- エラーハンドリングの充実

---

*この仕様書は開発進行に合わせて継続的に更新されます。*