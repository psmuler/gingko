# 俳句鑑賞＆記録アプリ「吟行」

言葉と場所を結ぶ、俳句の新しい楽しみ方「吟行」とは、旅先で心が動いた瞬間を捉え、俳句を作る（吟じる）ことです。
ルートを事前に決めたり、複数人で同じ場所を巡り、お互いに作った詩を選評し合うこともあります。
机に向かい頭を捻るのではなく、実際にその場に立つことで俳句そのものも変化し、より深い味わいが生まれます。
また、逆に俳句を利用して旅を豊かに記録することができます。
このアプリは、そんな「座」の文学をさらに広げるために、場所場所に紐づいた詩句をわかりやすく表示することを目指しています。

## 🎯 概要

「吟行」は俳句愛好家のための地図ベースのWebアプリです。俳句がどこで詠まれたか、句碑がどこにあるかを地図上で可視化し、俳句文化の地理的広がりを体感できます。

### 主な特徴

- **地図ベースの俳句探索**: 俳句を地図上のピンで表示し、土地の季節や枕を可視化
- **クラスタリング表示**: 同一地域の複数俳句を季節色でクラスタ表示、見やすさを向上
- **ハンバーガーメニュー**: About、統計、季語テスト機能付きの直感的ナビゲーション
- **3つの場所分類**: 句碑、紀行文、ゆかりの地による詳細な分類
- **シンプルな投稿機能**: ユーザー登録不要で誰でも俳句を投稿可能
- **モバイル対応**: レスポンシブデザインでスマートフォンでも快適に利用

## 🚀 すぐに使ってみる

1. `https://psmuler.github.io/claude_proj/` をWebブラウザで開く
2. 地図上のピンをクリックして俳句を鑑賞
3. 右下の ✍️ ボタンから新しい俳句を投稿

## 📱 機能一覧

### 🗾 地図機能

- **俳句の地図表示**: 地図上のピンで俳句の位置を表示
- **インテリジェントクラスタリング**: 同一地域の複数俳句を自動的にクラスタ化、ズーム時に個別表示
- **季語による色分け**:
  - 🔵 春（青）
  - 🔴 夏（赤）
  - ⚪ 秋（白）
  - ⚫ 冬（黒）
  - 🟡 暮・新年（黄）
  - 🔘 その他（グレー）
- **クラスタ季節表示**: クラスタ内の主要季節でクラスタ色を自動決定
- **ポップアップ最適化**: ピンが隠れない位置調整でより見やすく
- **現在地表示**: GPS機能を使った現在位置の取得

### ✍️ 俳句投稿機能

- **簡単投稿**: 俳句、詠み人、位置情報を入力して投稿
- **場所の種別選択**: 句碑、紀行文、ゆかりの地から選択
- **位置情報設定**: 手動入力または現在地取得
- **詠み人管理**: 新規詠み人登録または既存詠み人選択

### 🍔 ナビゲーション機能

- **ハンバーガーメニュー**: スマートなスライドアウトメニューでアプリ機能にアクセス
- **アプリ情報**: ピンの見方、使い方の詳細説明（独立HTMLファイル）
- **統計ページ**: 俳句・詠み人の統計情報表示
- **季語テスト**: 季語検出精度の確認・テスト機能

### 🔍 検索機能

- **俳句本文検索**: 俳句の文言での部分一致検索
- **詠み人検索**: 詠み人の名前（漢字・ひらがな）での検索
- **季節フィルタ**: 春・夏・秋・冬・暮新年での絞り込み
- **リアルタイム検索**: 入力と同時に検索結果を表示

## 🛠 技術仕様

### フロントエンド

- **HTML5**: セマンティックなマークアップ
- **CSS3**: CSS変数を使用したモダンなスタイリング、完全レスポンシブ
- **JavaScript**: ES6+のモダンな記法、非同期処理（async/await）
- **地図ライブラリ**: Leaflet + OpenStreetMap + MarkerCluster プラグイン
- **クラスタリング**: Leaflet.markercluster による動的ピングループ化
- **外部ライブラリ**: Supabase JavaScript SDK

### バックエンド・データベース

- **Supabase**: PostgreSQLベースのBaaS（Backend as a Service）
- **リアルタイム機能**: Supabaseのリアルタイム機能でデータ同期
- **RESTful API**: 自動生成されたRESTful APIエンドポイント
- **Row Level Security**: Supabaseの権限管理機能

### アーキテクチャパターン

- **APIアダプター**: Supabase/GAS API切り替え可能な統合インターフェース
- **モジュール分離**: 機能別にJavaScriptファイルを分割
- **AppManager パターン**: 中央集権的なアプリケーション状態管理
- **ユーティリティ分離**: 共通処理を`utils.js`で独立管理
- **設定駆動**: `config.js`での集中的な設定管理

## 📂 プロジェクト構成

```
俳句鑑賞アプリ/
├── index.html              # メインHTML
├── about.html              # アプリ情報ページ（独立HTML）
├── styles.css              # スタイルシート
├── script.js               # メインJavaScript
├── app-manager.js          # アプリケーション状態管理
├── utils.js                # 共通ユーティリティ関数
├── config.js               # アプリ設定ファイル
├── supabase-client.js      # Supabaseクライアント
├── api-adapter.js          # API統合インターフェース
├── api-client.js           # GAS APIクライアント（後方互換）
├── kigo-suggestions.js     # 季語サジェスト機能
├── pin-posting.js          # ピン投稿機能
├── seasonal-suggest.js     # 季節推定機能
├── kigo-test.js            # 季語テスト機能
├── CLAUDE.md              # 開発仕様書
├── README.md              # このファイル
├── requirements.txt       # Python依存関係
├── supabase_setup.sql     # データベースセットアップ
├── gas_api/               # Google Apps Script API関連
├── misc/                  # その他ファイル
└── venv/                  # Python仮想環境
```

## 🗃 データベース構造

### テーブル設計

#### `poets`（詠み人テーブル）
- `id`: 詠み人ID（主キー）
- `name`: 詠み人名
- `name_kana`: 詠み人名（ひらがな）
- `birth_year`: 生年
- `death_year`: 没年
- `period`: 時代
- `biography`: 経歴・説明

#### `haikus`（俳句テーブル）
- `id`: 俳句ID（主キー）
- `haiku_text`: 俳句本文
- `poet_id`: 詠み人ID（外部キー）
- `latitude`: 緯度
- `longitude`: 経度
- `location_type`: 場所種別（句碑/紀行文/ゆかりの地）
- `location_name`: 場所名
- `date_composed`: 詠まれた日付
- `description`: 説明・備考
- `season`: 季節
- `seasonal_term`: 季語

### サンプルデータ

現在約100件の俳句データと10名の詠み人データを収録しています。

## ⚙️ セットアップ・設定

### 1. 基本セットアップ

1. プロジェクトをダウンロード
2. `config.js`でSupabase接続情報を設定
3. Webサーバーで公開するか、ローカルで`index.html`を開く

### 2. Supabase設定

```javascript
// config.js
const SUPABASE_CONFIG = {
    url: 'https://your-project-id.supabase.co',
    anon_key: 'your-anon-key-here'
};
```

### 3. データベース初期化

```sql
-- supabase_setup.sqlを実行
-- テーブル作成とインデックス設定
```

## 🎮 使い方

### ユーザー向け

1. **俳句を見つける**
   - 地図をドラッグ・ズームして探索
   - ピンをクリックして俳句詳細を確認

2. **俳句を投稿する**
   - 右下の✍️ボタンをクリック
   - フォームに俳句、詠み人、位置情報を入力
   - 投稿ボタンで送信

3. **俳句を検索する**
   - 検索ボックスに俳句や詠み人名を入力
   - リアルタイムで検索結果を表示

### 開発者向け

1. **設定変更**
   ```javascript
   // config.jsでの設定例
   const APP_CONFIG = {
       USE_SUPABASE: true,  // Supabase使用フラグ
       DEBUG_MODE: false    // デバッグモード
   };
   ```

2. **APIの切り替え**
   - `config.js`の`USE_SUPABASE`フラグでSupabase/GAS API切り替え
   - APIアダプターが透過的に処理を切り替え

3. **スタイル変更**
   ```css
   /* styles.css - CSS変数での季節色変更例 */
   :root {
       --primary-color: #2c5aa0;
       --marker-spring: #3498db;  /* 春の色を変更 */
       --marker-summer: #e74c3c;  /* 夏の色を変更 */
   }
   ```

## 🔧 カスタマイズ

### 地図設定の変更

```javascript
// config.js
const MAP_CONFIG = {
    DEFAULT_CENTER: [35.6812, 139.7671], // 初期表示位置
    DEFAULT_ZOOM: 10,
    MARKER_COLORS: {
        '春': '#3498db',    // 青
        '夏': '#e74c3c',    // 赤
        '秋': '#ffffff',    // 白
        '冬': '#2c3e50',    // 黒
        '暮・新年': '#f1c40f', // 黄
        'その他': '#95a5a6'  // グレー
    }
};
```

### クラスタリング設定

```javascript
// config.js
const UI_CONFIG = {
    CLUSTER_MAX_RADIUS: 2,        // クラスタ化する最大半径（ピクセル）
    CLUSTER_DISABLE_AT_ZOOM: 10,  // クラスタリング無効化ズーム
    POPUP_OFFSET: [0, -40]        // ポップアップオフセット
};
```

### UI設定の調整

```javascript
// config.js
const UI_CONFIG = {
    LOADING_MIN_TIME: 500,
    ERROR_DISPLAY_TIME: 5000
};
```

## 🧪 開発・テスト

### ローカル開発

```bash
cd docs

# ローカルサーバーで開発する場合（Python）
python -m http.server 8000

# または（Node.js）
npx serve .
```

### デバッグ

```javascript
// config.js
const APP_CONFIG = {
    DEBUG_MODE: true  // コンソールログを詳細表示
};
```

## 📊 パフォーマンス

### 最適化済み機能

- **インデックス設定**: 地理検索、全文検索用の最適化されたインデックス
- **レスポンシブ画像**: 地図タイルの適切なキャッシュ
- **非同期読み込み**: JavaScriptの並列読み込み
- **データ圧縮**: 必要最小限のデータ転送
- **インテリジェントクラスタリング**: ズームレベルに応じた動的ピン表示
- **季節別クラスタ色分け**: 視覚的に分かりやすいクラスタ表現
- **モジュラー設計**: 機能別ファイル分割による保守性向上

### 推奨環境

- **ブラウザ**: Chrome 80+, Firefox 75+, Safari 13+, Edge 80+
- **ネットワーク**: 3G以上の通信環境
- **デバイス**: 画面解像度 320px以上

## 🤝 コントリビューション

### 今後の開発計画
現在はPhase 1が完了し、次なるPhase 2は「表示と投稿のUIの大幅改善」を柱として、以下の機能を計画中です：

- **ピンクラスタリング**: 同一地域に複数俳句がある場合の見やすい表示
- **ピン投稿**: 現在地のみに投稿できるボタン投稿ではなく、任意の地点を指定して俳句を投稿できるピン投稿へ変更。地図上でほぼ操作が完結し、画面に置くボタンは現在地に戻るボタンのみにする予定です。
    - これに伴い、ユーザーのフローは、地図上をタップすることを起点として→1. 既存の俳句表示 2. 新句入力 → 入力中にスワイプでさらに詳細入力画面へ遷移、という流れに変わります。
    - 既存俳句表示中にスワイプも詩句詳細画面へ遷移できるようにすると、より直感的に操作できるようになりそうです。
- **季語自動サジェスト**: 今回の実装の目玉です。俳句本文を入力すると、季語辞書を参照して季語、季節をボタンでサジェストします。これにより、ユーザーは季語選択の手間が大幅に軽減され、よりスムーズに投稿できます。
- **現在地に戻るボタンのデザインをナビアイコンに変更**: 地図アプリでよく見る二等辺三角形を切り欠いた形の青いアイコンにします。

その他、現在のPhaseでは取り組まないことに決めた機能を以下に示します：
- **俳句検索**: 俳句本文や詠み人名での全文検索。まだ俳句数詠み人数が少ないので、不要と判断しました。
- **古街道、古地図、宿場表示**: おくのほそ道など俳句が華開いた江戸期には、古街道や宿場が整備されていました。これらを地図上に表示することで、俳句の歴史的背景をより深く理解し、実際の地理と結びつけやすくします。
- **CSV一括投稿**: 管理者向け、ヘビーユース向けにCSVファイルからの一括データ登録機能。いろんなブログを見ていると、俳句やその背景、句碑などを公開されている人が多く、CSVでのものも見かけます。そういったデータを一括で取り込むのを容易にすることで、データベースの充実を図ります。著作権の観点で取り込みが非現実的なため、見送り。
- **ユーザー登録・ログイン**: ユーザーアカウントを作成し、投稿履歴やお気に入り俳句の保存が可能に。現状は匿名投稿のみ対応。
- **吟行専用詠み人ID**: 現在は適当に振られた通し番号のIDを使用していますが、せっかくなので年号を埋め込んだIDを採用したいと考えています。詠み人の初めの3桁を見ればおおよその生年がわかるようにする予定です。例えば `GRK`は元禄、`TNP`は天保といった具合です。実は`poet_id_system_spec.md`に少し仕様を整理しています。ちょっと初めてみましたが、元号を扱うのがかなり大変そうで、中座しています。
- **写真投稿** : 主には句碑写真を投稿できるようにする機能。

### コントリビューション方法
#### データ投稿

- アプリ内の投稿フォームから俳句データを追加
- 句碑の位置情報や写真の提供

#### 開発参加

- GitHubでのIssue報告、Pull Request歓迎
- 機能追加や不具合修正の提案

#### データ提供

- CSV形式での大量データ提供
- 句碑の写真や位置情報の提供

## 📄 ライセンス

このプロジェクトはオープンソースです。教育・研究・個人利用は自由に行えます。

## 🙏 謝辞

- 俳句データの提供者の皆様
- OpenStreetMapコミュニティ
- Supabaseチーム
- Leaflet開発チーム

## 📞 サポート・連絡

- **バグ報告**: GitHubのIssues
- **機能要望**: GitHubのIssues
- **質問**: GitHubのDiscussions

---

*俳句文化をデジタルで保存・共有し、次世代に継承することを目指しています。*